<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N&O Tech - Gestión</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}?v=2">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="{{ url_for('static', filename='js/rma_actions.js') }}?v=2" defer></script>
</head>
<body class="bg-dark text-white">

    <div class="container-fluid">
        <div class="row">
        {% if session.get('user_id') %}
            <nav class="col-md-2 sidebar d-flex flex-column p-3 border-end border-secondary vh-100 sticky-top overflow-y-auto" style="background-color: #0b0c10;">
                
                <div class="text-center mb-3">
                    <h4 class="text-warning fw-bold tracking-wider">N&O TECH</h4>
                    <div class="badge bg-secondary text-light opacity-50">SISTEMA v1.0</div>
                </div>

                <div class="mb-4 px-1">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-dark border-secondary" style="color: #adb5bd;"><i class="bi bi-search"></i></span>
                        <input type="text" 
                               id="globalSearch" 
                               class="form-control bg-dark text-white border-secondary" 
                               placeholder="Buscar SN o IP..." 
                               onkeydown="handleSearch(event)"
                               style="color: #fff !important;">
                    </div>
                </div>

                <ul class="nav flex-column mb-auto">
                    <li class="nav-item mb-2"><a class="nav-link text-white d-flex align-items-center gap-2" href="{{ url_for('main.index') }}"><i class="bi bi-speedometer2 text-info"></i> Inicio</a></li>
                    
                    {% set user_role = session.get('role', '') %}
                    {% if 'Site Manager' in user_role or 'Coordinador' in user_role %}
                    <li class="nav-item mb-2"><a class="nav-link text-white d-flex align-items-center gap-2" href="{{ url_for('main.monitor') }}"><i class="bi bi-activity text-success"></i> Monitor</a></li>
                    <li class="nav-item mb-2"><a class="nav-link text-white d-flex align-items-center gap-2" href="{{ url_for('diagnostico.historial_diagnosticos') }}"><i class="bi bi-clipboard-data text-info"></i> Diagnóstico</a></li>
                    {% endif %}

                    {# Link Panel Laboratorio - Visible para Coordinadores y Lab #}
                    {% set user_role = session.get('role', '') %}
                    {% if 'Site Manager' in user_role or 'Coordinador' in user_role or 'Tecnico Lab' in user_role or 'Técnico de Laboratorio' in user_role or 'Supervisor' in user_role %}
                    <li class="nav-item mb-2">
                        <a class="nav-link text-white d-flex align-items-center gap-2" href="{{ url_for('lab_approvals.panel') }}">
                            <i class="bi bi-shield-check text-info"></i> Pre-Aprobación Lab
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link text-white d-flex align-items-center gap-2" href="{{ url_for('lab_routes.garantias') }}">
                            <i class="bi bi-calendar-check text-warning"></i> Garantías
                        </a>
                    </li>
                    {% endif %}
                    
                    {# Enlace a Solicitudes de Traslado - Visible para todos pero con badge para Coordinadores #}
                    <li class="nav-item mb-2">
                        <a class="nav-link text-white d-flex align-items-center justify-content-between" 
                           href="{{ url_for('transfers.panel') }}"
                           onclick="var el = document.getElementById('solicitudes-traslado'); if(el) { el.scrollIntoView({behavior: 'smooth', block: 'start'}); return false; }">
                            <span><i class="bi bi-arrow-left-right text-warning"></i> Solicitudes Traslado</span>
                            {% if session.get('role') in ['Site Manager', 'Coordinador'] %}
                            <span class="badge bg-warning text-dark" 
                                  hx-get="{{ url_for('transfers.badge_count') }}"
                                  hx-trigger="every 10s, transferApproved from:body"
                                  hx-swap="innerHTML">
                                0
                            </span>
                            {% endif %}
                        </a>
                    </li>

                    <li class="nav-item mb-2">
                        <a class="nav-link text-white d-flex align-items-center gap-2" href="{{ url_for('conciliacion_dash.dashboard') }}">
                            <i class="bi bi-tools text-warning"></i> Mis Conciliaciones
                        </a>
                    </li>
                    
                    <hr class="text-secondary my-3 opacity-25">

                    {% set user_role = session.get('role', '') %}
                    {% if session.get('mis_wh') and 'Coordinador' not in user_role and 'Site Manager' not in user_role and 'Manager' not in user_role %}
                        <div class="mb-3">
                            <p class="small text-warning text-uppercase fw-bold px-3 mb-2" style="font-size: 0.7rem;"><i class="bi bi-star-fill me-1"></i> Mis Zonas</p>
                            {% for w in session.get('mis_wh') %}
                            <li class="nav-item"><a class="nav-link py-2 text-white hover-light fw-bold d-flex align-items-center" href="/dashboard/{{ w }}/1" style="background: rgba(255, 193, 7, 0.08); border-left: 3px solid var(--accent); margin-bottom: 4px; border-radius: 0 4px 4px 0;"><i class="bi bi-geo-alt-fill me-2 text-warning"></i> WH {{ w }}</a></li>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {% if session.get('depto') != 'Hydro' %}
                    <div class="mt-1">
                        <button class="btn d-flex align-items-center justify-content-between w-100 px-3 py-2 fw-bold border-0 bg-transparent" style="color: #adb5bd;" data-bs-toggle="collapse" data-bs-target="#wh-collapse">
                            <span><i class="bi bi-grid me-2"></i> TODOS LOS WH</span><i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="collapse" id="wh-collapse">
                            <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small mt-1 ps-2 border-start border-secondary ms-3">
                                {% for w in range(1, 11) %}
                                <li><a href="/dashboard/{{ w }}/1" class="nav-link py-1 text-secondary d-flex align-items-center hover-white"><span style="width: 20px; text-align: center;">{{ w }}</span><span class="ms-2">Warehouse</span></a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    {% endif %}
                </ul>

                <div class="mt-4 pt-3 border-top border-secondary">
                    <div class="d-flex align-items-center mb-3 px-2">
                        <div class="flex-grow-1 overflow-hidden">
                            <small class="d-block text-white fw-bold">{{ session.get('username', 'Usuario') }}</small>
                            <small class="d-block text-uppercase" style="font-size: 0.65rem; color: #adb5bd;">{{ session.get('role', 'Técnico') }}</small>
                        </div>
                    </div>
                    <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger w-100 btn-sm fw-bold"><i class="bi bi-box-arrow-right"></i> SALIR</a>
                </div>
            </nav>
        {% endif %}

            <main class="{{ 'col-md-10' if session.get('user_id') else 'col-12' }} p-4" style="background-color: #06070a;" id="main-area">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <!-- MODAL SELECCIÓN: DIAGNÓSTICO VS RMA -->
    <div class="modal fade" id="modalDecision" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary shadow-lg">
                <div class="modal-header border-bottom border-secondary bg-black">
                    <h5 class="modal-title text-white"><i class="bi bi-gear-wide-connected me-2"></i>Gestión de Equipo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4 text-center">
                    <h4 class="text-white mb-2" id="decision-title">Ubicación...</h4>
                    <p class="text-secondary mb-4">Seleccione una acción para este equipo</p>
                    
                    <div class="row g-3">
                        <div class="col-6">
                            <button class="btn btn-outline-info w-100 py-3 hover-light" onclick="abrirFormularioDiagnostico()">
                                <i class="bi bi-clipboard-check fs-1 mb-2 d-block"></i>
                                <span class="fw-bold">DIAGNOSTICAR</span>
                                <div class="small text-secondary mt-1">Registrar intento de reparación in-situ</div>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-warning w-100 py-3 hover-light" onclick="abrirRMA()">
                                <i class="bi bi-tools fs-1 mb-2 d-block"></i>
                                <span class="fw-bold">RMA / PIEZAS</span>
                                <div class="small text-secondary mt-1">Enviar a Lab o pedir repuesto</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL FORMULARIO DIAGNÓSTICO -->
    <div class="modal fade" id="modalDiagnostico" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content bg-dark border-info shadow-lg">
                <div class="modal-header border-bottom border-secondary bg-black">
                    <h5 class="modal-title text-info"><i class="bi bi-clipboard-pulse me-2"></i>Nuevo Diagnóstico</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="formDiagnostico">
                        <input type="hidden" id="diag-wh">
                        <input type="hidden" id="diag-rack">
                        <input type="hidden" id="diag-fila">
                        <input type="hidden" id="diag-columna">
                        <input type="hidden" id="diag-miner-id">
                        
                        <div class="alert alert-dark border-secondary mb-4 d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-secondary d-block">Ubicación</small>
                                <strong class="text-white" id="diag-ubicacion-txt">...</strong>
                            </div>
                            <div class="text-end">
                                <small class="text-secondary d-block">SN Físico Actual</small>
                                <strong class="text-warning" id="diag-sn-txt">...</strong>
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label small text-white-50">IP Address</label>
                                <input type="text" class="form-control bg-black text-white border-secondary" id="diag-ip" placeholder="Ej: 192.168...">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small text-info fw-bold">SN Digital</label>
                                <input type="text" class="form-control bg-black text-info border-info" id="diag-sn-digital" placeholder="Escanear SN Digital...">
                            </div>
                        </div>

                        <h6 class="text-white border-bottom border-secondary pb-1 mt-4 mb-3">Detalles Técnicos</h6>
                        
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label small text-white-50">Falla Detectada *</label>
                                <select class="form-select bg-dark text-white border-secondary" id="diag-falla" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="Frecuencia">Frecuencia / Hashrate Bajo</option>
                                    <option value="Fuente">Fuente (PSU)</option>
                                    <option value="Control Board">Control Board</option>
                                    <option value="Fan">Fan / Ventilación</option>
                                    <option value="Hashboard">Hashboard (0 chips / x)</option>
                                    <option value="Firmware">Firmware / Virus</option>
                                    <option value="PDU">PDU / Energía Rack</option>
                                    <option value="Red">Red / Conectividad</option>
                                    <option value="Switch">Switch / Puerto</option>
                                    <option value="Desconocido">Desconocido</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small text-white-50">Solución Aplicada *</label>
                                <select class="form-select bg-dark text-white border-secondary" id="diag-solucion" required onchange="checkSolucionDiag(this.value)">
                                    <option value="">Seleccionar...</option>
                                    <option value="Reinicio interfaz">Reinicio desde la interfaz</option>
                                    <option value="Restauración y FW">Restauración y Firmware</option>
                                    <option value="Reinicio manual">Reinicio físico (Manual)</option>
                                    <option value="Crimpeo Ethernet">Crimpeo Cable Ethernet</option>
                                    <option value="Firmware Update">Actualización Firmware</option>
                                    <option value="Reinicio PDU">Reinicio PDU</option>
                                    <option value="Conciliación">Conciliación (Cambio Pieza)</option>
                                    <option value="RMA">Derivar a RMA</option>
                                    <option value="Restauración">Solo Restauración</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label small text-white-50">Observación / Notas</label>
                            <textarea class="form-control bg-black text-white border-secondary" id="diag-observacion" rows="2" placeholder="Detalles extra..."></textarea>
                        </div>

                        <div class="d-grid">
                            <button type="button" class="btn btn-info fw-bold py-2" onclick="guardarDiagnostico()">
                                <i class="bi bi-save me-2"></i> GUARDAR HISTORIAL
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="modalMiner" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary shadow-lg">
                <div class="modal-header border-secondary bg-black py-2">
                    <h5 class="modal-title fs-6"><i class="bi bi-hdd-rack me-2 text-warning"></i> Posición: <span id="modal-titulo" class="text-warning fw-bold">...</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="formMiner" action="/api/guardar" method="POST">
                        <input type="hidden" name="wh" id="input-wh"><input type="hidden" name="rack" id="input-rack">
                        <input type="hidden" name="fila" id="input-fila"><input type="hidden" name="columna" id="input-columna">

                        <div class="row g-2 mb-3">
                            <div class="col-md-3"><label class="small text-secondary">Modelo</label><input type="text" class="form-control form-control-sm" name="modelo" id="input-modelo"></div>
                            <div class="col-md-2"><label class="small text-secondary">TH/s *</label><input type="number" step="0.1" class="form-control form-control-sm" name="ths" id="input-ths"></div>
                            <div class="col-md-7"><label class="small text-secondary">MAC Address *</label><input type="text" class="form-control form-control-sm" name="mac" id="input-mac"></div>
                        </div>

                        <div class="row g-2 mb-3 p-2 rounded" style="background: rgba(255, 193, 7, 0.05); border: 1px dashed #444;">
                            <div class="col-md-6"><label class="small text-warning fw-bold">SN FÍSICO *</label><input type="text" class="form-control form-control-sm border-warning text-warning" name="sn_fisica" id="input-sn"></div>
                            <div class="col-md-6"><label class="small text-info fw-bold">SN DIGITAL</label><input type="text" class="form-control form-control-sm border-info text-info" name="sn_digital" id="input-sn-digital"></div>
                        </div>

                        <h6 class="text-white border-bottom border-secondary pb-1 mb-3 small fw-bold mt-4">COMPONENTES INTERNOS</h6>
                        <div class="row g-2 mb-3">
                            <div class="col-md-4"><label class="small text-secondary">PSU Model</label><input type="text" class="form-control form-control-sm" name="psu_model" id="input-psu-model"></div>
                            <div class="col-md-4"><label class="small text-secondary">PSU SN</label><input type="text" class="form-control form-control-sm" name="psu_sn" id="input-psu"></div>
                            <div class="col-md-4"><label class="small text-secondary">Control Board SN</label><input type="text" class="form-control form-control-sm" name="cb_sn" id="input-cb"></div>
                            <div class="col-md-4"><label class="small text-secondary">HB1 SN (CH0)</label><input type="text" class="form-control form-control-sm" name="hb1_sn" id="input-hb1"></div>
                            <div class="col-md-4"><label class="small text-secondary">HB2 SN (CH1)</label><input type="text" class="form-control form-control-sm" name="hb2_sn" id="input-hb2"></div>
                            <div class="col-md-4"><label class="small text-secondary">HB3 SN (CH2)</label><input type="text" class="form-control form-control-sm" name="hb3_sn" id="input-hb3"></div>
                        </div>

                        <div class="mt-4 border-top border-secondary pt-3">
                            <label class="small text-danger fw-bold mb-2">DIAGNÓSTICO (para RMA)</label>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <select class="form-select form-select-sm bg-dark text-white" name="diagnostico_detalle" id="input-falla">
                                        <option value="">-- Seleccionar Falla * --</option>
                                        <option value="HASHBOARD">HASHBOARD</option>
                                        <option value="PSU">PSU</option>
                                        <option value="CONTROL BOARD">CONTROL BOARD</option>
                                        <option value="FAN">FAN</option>
                                        <option value="OTHER">OTRO</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" 
                                           class="form-control form-control-sm bg-dark text-white border-warning" 
                                           name="ip_rma" 
                                           id="input-ip-rma"
                                           placeholder="IP del puerto actual *">
                                    <small class="text-white" style="font-size: 0.7rem;">IP del switch donde está conectada</small>
                                </div>
                                <div class="col-md-4">
                                    <textarea class="form-control form-control-sm bg-dark text-white" name="log_detalle" rows="1" placeholder="Pegar log *..." id="input-log"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer border-top border-secondary mt-3 px-0 pb-0 d-flex justify-content-between">
                            
                            <div>
                                <button type="submit" class="btn btn-warning btn-sm fw-bold text-dark px-4">
                                    <i class="bi bi-save me-1"></i> GUARDAR
                                </button>
                            </div>

                            <div id="btns-normal">
                                <button type="button" onclick="validarYEnviarRMA()" class="btn btn-danger btn-sm fw-bold px-3">
                                    <i class="bi bi-file-earmark-spreadsheet me-1"></i> ENVIAR A RMA
                                </button>
                            </div>

                        </div>
                        </form>
                        
                        <!-- BOTONES DE RMA (fuera del form para que no se oculten) -->
                        <div id="btns-rma" style="display: none;">
                            <div class="alert alert-warning mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Equipo con RMA registrado.</strong> Selecciona una acción:
                            </div>
                            <div class="d-grid gap-2">
                                <button type="button" 
                                        class="btn btn-warning btn-lg" 
                                        onclick="solicitarTrasladoRMA()">
                                    <i class="bi bi-arrow-left-right me-2"></i>
                                    Solicitar Traslado al Laboratorio
                                </button>
                                
                                <button type="button" 
                                        class="btn btn-success" 
                                        onclick="conciliarMiner()">
                                    <i class="bi bi-check2-circle me-2"></i>
                                    Conciliación de Piezas
                                </button>
                                
                                <button type="button" 
                                        class="btn btn-outline-danger" 
                                        onclick="cancelarRMA()">
                                    <i class="bi bi-x-circle me-2"></i>
                                    Cancelar RMA (Error de Registro)
                                </button>
                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/api_service.js') }}?v=3"></script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}?v=3"></script>
    <style>.hover-light:hover { background-color: rgba(255,255,255,0.1) !important; color: #fff !important; } .hover-white:hover { color: #fff !important; }</style>
</body>
</html>